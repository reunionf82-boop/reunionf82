# 클라우드웨이즈 서버 메모리 사용량 분석

## 현재 메모리 사용 패턴

### 1. Node.js 기본 메모리
- **RSS (실제 메모리)**: 약 35MB
- **Heap**: 약 5MB
- 빈 Node.js 프로세스만 실행해도 최소 35MB 필요

### 2. Express 및 라이브러리
- Express 프레임워크: ~5-10MB
- @google/generative-ai 라이브러리: ~5-10MB
- dotenv, cors 등: ~1-2MB
- **총 추가 메모리**: 약 10-20MB

### 3. 스트리밍 처리 중 메모리

#### `accumulatedText` 변수
- 최대 100,000자까지 누적 (MAX_TEXT_LENGTH_BEFORE_RETRY)
- UTF-8 한글 기준: 100,000자 × 3바이트 = 약 300KB (0.3MB)
- 실제로는 HTML 태그 포함으로 더 클 수 있음

#### `parseCompletedSubtitles` 함수
- 전체 HTML을 메모리에 로드: ~0.3-1MB
- 정규식 매칭을 위한 복사본: ~0.3-1MB
- `subtitleSections` 배열: 각 섹션의 복사본 저장 (~0.5-2MB)
- **총 파싱 중 메모리**: 약 1-4MB

#### 기타 스트리밍 처리
- 청크 버퍼: ~0.1-0.5MB
- 응답 버퍼: ~0.1-0.5MB
- **총 추가 버퍼**: 약 0.2-1MB

### 4. 총 메모리 요구량

```
최소 메모리 = Node.js 기본(35MB) + 라이브러리(10MB) + 스트리밍(1MB) = 46MB
일반적인 사용 = Node.js 기본(35MB) + 라이브러리(15MB) + 스트리밍(3MB) = 53MB
피크 사용 = Node.js 기본(35MB) + 라이브러리(20MB) + 스트리밍(5MB) = 60MB
```

## 문제점

### ⚠️ **450-600KB 가용 메모리는 치명적입니다**

현재 상황: **가용 메모리가 450-600KB (0.45-0.6MB) 수준**

1. **Node.js 프로세스 시작 완전 불가능**
   - Node.js는 최소 10-20MB, 일반적으로 30-50MB 필요
   - 0.6MB는 Node.js 프로세스가 시작되는 데 필요한 메모리의 약 **1-2%**에 불과
   - **서버가 실행되지 않거나 즉시 강제 종료됨**

2. **메모리 부족으로 인한 심각한 문제**
   - ❌ Node.js 프로세스 시작 실패
   - ❌ 프로세스 즉시 강제 종료 (OOM Kill)
   - ❌ 스트리밍 완전 불가능
   - ❌ 모든 요청 실패 또는 타임아웃
   - ❌ 파싱 오류 및 메모리 할당 실패

3. **가능한 원인**
   - 시스템 전체 메모리가 거의 고갈된 상태
   - 다른 프로세스(아파치, MySQL, PHP 등)가 대부분의 메모리 사용 중
   - 서버 사양이 매우 낮음 (예: 256MB 이하)
   - 메모리 누수 또는 과도한 프로세스 실행

4. **현재 서버 상태 추정**
   - Node.js 서버가 실행 중이라면 매우 불안정한 상태
   - 요청 처리 중 메모리 부족으로 즉시 종료 가능
   - 스트리밍 처리 중 중단될 가능성 매우 높음

## 권장 사항

### 1. ⚠️ 즉시 긴급 조치 (필수)

#### A. 메모리 상태 확인 (SSH 터미널)
```bash
# 전체 메모리 사용량 확인
free -h

# 메모리를 많이 사용하는 프로세스 확인
ps aux --sort=-%mem | head -20

# Node.js 프로세스 확인
ps aux | grep node

# 시스템 전체 메모리 정보
cat /proc/meminfo | grep -E "MemTotal|MemFree|MemAvailable"
```

#### B. 메모리 확보 방법
1. **불필요한 프로세스 종료**
   - 사용하지 않는 PHP 프로세스 종료
   - 사용하지 않는 MySQL 연결 종료
   - 로그 파일 정리: `rm -rf /var/log/*.log` (주의: 필요한 로그는 보존)

2. **서버 재시작** (가능한 경우)
   ```bash
   # 현재 실행 중인 Node.js 프로세스 확인
   pm2 list
   # 또는
   ps aux | grep node
   
   # 서버 재시작 (Cloudways 대시보드에서도 가능)
   pm2 restart all
   ```

3. **임시 해결: 코드 최적화** (완전한 해결책은 아님)
   - 코드 최적화만으로는 해결 불가능 (메모리가 너무 부족)
   - 하지만 일부 완화는 가능 (아래 참조)

### 2. 단기적 완화 (부분적 효과만)

**⚠️ 주의: 0.6MB 메모리로는 Node.js가 실행될 수 없으므로, 코드 최적화만으로는 해결 불가능합니다.**

하지만 메모리가 약간 확보되면 도움이 될 수 있는 최적화:

- `parseCompletedSubtitles` 호출 빈도 줄이기 (50청크 → 100청크)
- 파싱 후 중간 데이터 즉시 해제
- 불필요한 로그 제거
- `accumulatedText` 최대 길이 제한 강화 (100K → 80K)

### 3. 장기적 해결 (필수)

#### A. 서버 사양 업그레이드 (가장 중요)
- **최소 필요 메모리: 512MB**
- **권장 메모리: 1GB 이상**
- 클라우드웨이즈 플랜 확인 및 업그레이드

#### B. 메모리 사용 최적화
- 불필요한 서비스 비활성화
- 메모리 모니터링 도구 도입
- 메모리 사용 패턴 분석 및 최적화
- 스왑 메모리 설정 (임시 완화)

### 4. 현재 상황에서의 동작 가능성

**450-600KB 가용 메모리 상태:**
- ❌ Node.js 프로세스 시작: **불가능**
- ❌ 서버 실행: **불가능 또는 즉시 종료**
- ❌ 스트리밍 처리: **완전 불가능**
- ❌ 정상적인 API 호출: **불가능**

**결론: 현재 메모리 상태로는 서버가 정상 작동할 수 없습니다.**

## 참고사항

- 클라우드웨이즈 무료 티어는 일반적으로 256MB 이상 제공
- 450-600KB는 전체 시스템 메모리 중 가용 메모리
- 실제 Node.js 프로세스는 더 많은 메모리를 사용하므로, 전체 시스템 메모리가 거의 고갈된 상태

## 메모리 확인 방법

### SSH 터미널에서 메모리 확인

```bash
# 1. 전체 메모리 상태 확인
free -h
# 출력 예시:
#               total        used        free      shared  buff/cache   available
# Mem:           256M        240M         2M         4M        14M        12M
# Swap:            0B          0B          0B

# 2. 메모리를 많이 사용하는 프로세스 확인 (상위 10개)
ps aux --sort=-%mem | head -11

# 3. Node.js 프로세스 메모리 사용량 확인
ps aux | grep node | awk '{print $2, $4, $11}'

# 4. 시스템 전체 메모리 정보 상세 확인
cat /proc/meminfo

# 5. 사용 가능한 메모리만 확인
cat /proc/meminfo | grep MemAvailable
```

### Cloudways 대시보드에서 확인

1. **Cloudways → 해당 Server → Monitoring**
2. **Memory Usage** 그래프 확인
3. **Resource Usage** 탭에서 상세 정보 확인

### 메모리 부족 시 확인할 사항

1. **어떤 프로세스가 메모리를 많이 사용하는가?**
   ```bash
   ps aux --sort=-%mem | head -20
   ```

2. **Node.js 프로세스가 실행 중인가?**
   ```bash
   ps aux | grep node
   pm2 list  # PM2 사용 시
   ```

3. **서버가 메모리 부족으로 종료되었는가?**
   ```bash
   dmesg | grep -i "out of memory"
   dmesg | grep -i "killed process"
   ```

4. **총 메모리가 얼마인가?**
   ```bash
   free -h
   cat /proc/meminfo | grep MemTotal
   ```

## 임시 해결책 (비권장, 하지만 긴급 시)

현재 메모리 상태에서는 서버를 실행할 수 없지만, 메모리가 약간 확보되면:

1. **스왑 메모리 생성** (성능 저하 있음)
2. **불필요한 서비스 일시 중지**
3. **메모리 사용량이 적은 다른 서버로 이전 고려**

하지만 **가장 근본적인 해결책은 서버 메모리 증설**입니다.
